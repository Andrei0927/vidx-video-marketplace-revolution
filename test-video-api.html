<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video API Tester - VidX</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üé¨ Video Generation API Tester</h1>
            <p class="text-gray-600 mb-8">Test the OpenAI video pipeline directly</p>

            <!-- API Configuration -->
            <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h2 class="text-lg font-semibold text-blue-900 mb-2">API Configuration</h2>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Backend URL:</label>
                        <input type="text" id="backend-url" value="https://video-marketplace-api.victoriousforest-01a281fd.northeurope.azurecontainerapps.io" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Session Token:</label>
                        <input type="text" id="session-token" placeholder="Your session token (login first)" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Login at the main site, then check localStorage.sessionToken in browser console</p>
                    </div>
                </div>
            </div>

            <!-- Test 1: Script Generation -->
            <div class="mb-8 border border-gray-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üìù Test 1: Generate Script</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title:</label>
                        <input type="text" id="script-title" value="2020 Toyota Camry" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description:</label>
                        <textarea id="script-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md">Excellent condition family sedan with low mileage. Perfect first car or reliable daily driver. Full service history, one owner, accident-free.</textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category:</label>
                            <select id="script-category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="automotive">Automotive</option>
                                <option value="electronics">Electronics</option>
                                <option value="fashion">Fashion</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price:</label>
                            <input type="number" id="script-price" value="18500" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>

                    <button onclick="testScriptGeneration()" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        Generate Script
                    </button>

                    <div id="script-result" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-md">
                        <h3 class="font-semibold text-gray-900 mb-2">Result:</h3>
                        <pre id="script-output" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                    </div>

                    <div id="script-error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <h3 class="font-semibold text-red-900 mb-2">Error:</h3>
                        <pre id="script-error-output" class="text-sm text-red-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>

            <!-- Test 2: Full Video Generation -->
            <div class="mb-8 border border-gray-200 rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üé• Test 2: Generate Video</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title:</label>
                        <input type="text" id="video-title" value="2020 Toyota Camry" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description:</label>
                        <textarea id="video-description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md">Excellent condition family sedan with low mileage. Perfect first car or reliable daily driver. Full service history, one owner, accident-free.</textarea>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category:</label>
                            <select id="video-category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="automotive">Automotive</option>
                                <option value="electronics">Electronics</option>
                                <option value="fashion">Fashion</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price:</label>
                            <input type="number" id="video-price" value="18500" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Voice:</label>
                            <select id="video-voice" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option value="alloy">Alloy (Neutral)</option>
                                <option value="echo">Echo (Male)</option>
                                <option value="fable">Fable (British)</option>
                                <option value="onyx">Onyx (Deep)</option>
                                <option value="nova">Nova (Warm)</option>
                                <option value="shimmer">Shimmer (Soft)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Images (JPG/PNG):</label>
                        <input type="file" id="video-images" multiple accept="image/*" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Select 2-5 product images</p>
                    </div>

                    <button onclick="testVideoGeneration()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                        Generate Video
                    </button>

                    <div id="video-progress" class="hidden mt-4">
                        <div class="flex items-center justify-between text-sm text-gray-700 mb-2">
                            <span id="video-status">Processing...</span>
                            <span id="video-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="video-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="video-result" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-md">
                        <h3 class="font-semibold text-gray-900 mb-2">Video Generated! üéâ</h3>
                        <div id="video-output"></div>
                    </div>

                    <div id="video-error" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <h3 class="font-semibold text-red-900 mb-2">Error:</h3>
                        <pre id="video-error-output" class="text-sm text-red-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>

            <!-- Health Check -->
            <div class="border-t border-gray-200 pt-6">
                <button onclick="testHealth()" 
                        class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">
                    Test Backend Health
                </button>
                <div id="health-result" class="hidden mt-4 p-4 bg-gray-50 border border-gray-200 rounded-md">
                    <pre id="health-output" class="text-sm text-gray-700"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function testHealth() {
            const backendUrl = document.getElementById('backend-url').value;
            const resultDiv = document.getElementById('health-result');
            const outputDiv = document.getElementById('health-output');

            try {
                resultDiv.classList.remove('hidden');
                outputDiv.textContent = 'Testing...';

                const response = await fetch(`${backendUrl}/health`);
                const data = await response.json();

                outputDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testScriptGeneration() {
            const backendUrl = document.getElementById('backend-url').value;
            const sessionToken = document.getElementById('session-token').value;
            const resultDiv = document.getElementById('script-result');
            const errorDiv = document.getElementById('script-error');
            const outputDiv = document.getElementById('script-output');
            const errorOutput = document.getElementById('script-error-output');

            if (!sessionToken) {
                alert('Please enter your session token first!');
                return;
            }

            try {
                resultDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                outputDiv.textContent = 'Generating script...';

                const requestData = {
                    title: document.getElementById('script-title').value,
                    description: document.getElementById('script-description').value,
                    category: document.getElementById('script-category').value,
                    price: parseFloat(document.getElementById('script-price').value)
                };

                console.log('Request:', requestData);

                const response = await fetch(`${backendUrl}/api/video/generate-script`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                resultDiv.classList.remove('hidden');
                outputDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                errorDiv.classList.remove('hidden');
                errorOutput.textContent = error.message;
            }
        }

        async function testVideoGeneration() {
            const backendUrl = document.getElementById('backend-url').value;
            const sessionToken = document.getElementById('session-token').value;
            const progressDiv = document.getElementById('video-progress');
            const resultDiv = document.getElementById('video-result');
            const errorDiv = document.getElementById('video-error');
            const statusSpan = document.getElementById('video-status');
            const percentSpan = document.getElementById('video-percent');
            const progressBar = document.getElementById('video-progress-bar');
            const outputDiv = document.getElementById('video-output');
            const errorOutput = document.getElementById('video-error-output');

            if (!sessionToken) {
                alert('Please enter your session token first!');
                return;
            }

            const fileInput = document.getElementById('video-images');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select at least one image!');
                return;
            }

            try {
                resultDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                progressDiv.classList.remove('hidden');
                
                statusSpan.textContent = 'Uploading images...';
                percentSpan.textContent = '10%';
                progressBar.style.width = '10%';

                const formData = new FormData();
                formData.append('title', document.getElementById('video-title').value);
                formData.append('description', document.getElementById('video-description').value);
                formData.append('category', document.getElementById('video-category').value);
                formData.append('price', document.getElementById('video-price').value);
                formData.append('voice', document.getElementById('video-voice').value);

                for (let file of fileInput.files) {
                    formData.append('images', file);
                }

                statusSpan.textContent = 'Generating video...';
                percentSpan.textContent = '20%';
                progressBar.style.width = '20%';

                const response = await fetch(`${backendUrl}/api/video/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                statusSpan.textContent = 'Complete!';
                percentSpan.textContent = '100%';
                progressBar.style.width = '100%';

                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    resultDiv.classList.remove('hidden');
                    
                    outputDiv.innerHTML = `
                        <div class="space-y-2">
                            <p><strong>Video URL:</strong> <a href="${data.videoUrl}" target="_blank" class="text-blue-600 hover:underline">${data.videoUrl}</a></p>
                            <p><strong>Script:</strong> ${data.script}</p>
                            <p><strong>Duration:</strong> ${data.duration}s</p>
                            <p><strong>Cost:</strong> $${data.cost.toFixed(4)}</p>
                            ${data.thumbnailUrl ? `<p><strong>Thumbnail:</strong> <a href="${data.thumbnailUrl}" target="_blank" class="text-blue-600 hover:underline">View</a></p>` : ''}
                        </div>
                    `;
                }, 500);

            } catch (error) {
                progressDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errorOutput.textContent = error.message;
            }
        }
    </script>
</body>
</html>
