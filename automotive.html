<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Automotive - VidX</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VidX">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/ios/180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/ios/152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/ios/120.png">
    <script>
        (function() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            50: '#18191A',
                            100: '#242526',
                            200: '#3A3B3C',
                            300: '#4E4F50',
                            400: '#6B6C6D',
                            500: '#B0B3B8',
                            600: '#E4E6EB',
                            700: '#F5F6F7'
                        }
                    }
                }
            }
        };
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="/css/dark-mode.css">
    <script src="components/auth-modal.js"></script>
    <style>
        html, body {
            min-height: 100%;
        }

        .scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #f1f1f1;
        }
        .scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #6366f1;
            border-radius: 10px;
        }
        .filter-option {
            transition: all 0.2s ease;
        }
        .filter-option:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        .filter-option.active {
            background-color: #6366f1;
            color: white;
        }
        /* Mobile-first portrait video grid */
        .video-grid {
            display: grid;
            gap: 1.5rem;
            padding: 0 1rem;
        }
        
        /* Mobile: Full-screen snap scrolling (TikTok style) */
        @media (max-width: 1023px) {
            body {
                padding: 0;
                margin: 0;
                overflow-x: hidden;
            }
            
            .video-grid {
                display: block;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for iOS */
                overflow-y: scroll;
                overflow-x: hidden;
                scroll-snap-type: y mandatory;
                scroll-behavior: smooth;
                padding: 0;
                margin: 0;
                gap: 0;
                -webkit-overflow-scrolling: touch;
            }
            
            .video-card {
                scroll-snap-align: start;
                scroll-snap-stop: always;
                min-height: 100vh;
                min-height: 100dvh;
                height: 100vh;
                height: 100dvh;
                width: 100vw;
                max-width: 100vw;
                margin-bottom: 0 !important;
                border-radius: 0;
            }
        }
        
        /* Desktop layout */
        @media (min-width: 1024px) {
            .video-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                justify-items: center;
                gap: 2.5rem;
                padding: 0 2rem 2.5rem;
                max-width: 1200px;
                margin: 6rem auto 0; /* Added top margin to push videos below header */
            }
        }

        .video-card {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            /* Portrait aspect ratio 9:16 for mobile video */
            aspect-ratio: 9 / 16;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
        }
        
        @media (min-width: 1024px) {
            .video-card {
                margin-bottom: 0;
                width: min(100%, 360px);
                max-width: 360px;
            }
        }

        @media (min-width: 1440px) {
            .video-card {
                max-width: 400px;
            }
        }
        
        .video-card video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
            pointer-events: none;
        }
        
        .video-card video::-webkit-media-controls {
            display: none !important;
        }
        
        .video-card video::-webkit-media-controls-enclosure {
            display: none !important;
        }
        
        .volume-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 9999px;
            padding: 0.5rem;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        
        .volume-indicator.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
            z-index: 5;
            pointer-events: none; /* Allow clicks to pass through overlay */
        }

        /* Mobile: Add padding for bottom nav */
        @media (max-width: 1023px) {
            .video-overlay {
                padding-bottom: calc(5rem + env(safe-area-inset-bottom, 0px)); /* 5rem = 80px for nav bar + 1.5rem padding */
            }
        }

        /* Desktop: Normal padding */
        @media (min-width: 1024px) {
            .video-overlay {
                padding-bottom: 1.5rem;
            }
        }
        
        .video-overlay a,
        .video-overlay button,
        .volume-indicator {
            pointer-events: auto; /* Only interactive elements capture clicks */
        }
    </style>
    <!-- Note: feather icons don't have a 'car' icon; we'll use 'truck' later in the body -->
</head>
<body class="bg-gray-50 dark:bg-dark-50 dark-mode-transition">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-dark-100 shadow-sm dark:shadow-dark-200 hidden lg:block">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <i data-feather="video" class="text-indigo-600 dark:text-indigo-400 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-gray-900 dark:text-dark-600">VidX</span>
                    </a>
                    <!-- Category Quick Links in Header (Desktop Only) -->
                    <div class="hidden md:flex items-center space-x-2">
                        <a href="automotive.html" class="px-3 py-1.5 text-sm font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-dark-200 rounded-md">
                            Automotive
                        </a>
                        <a href="electronics.html" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-dark-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-gray-50 dark:hover:bg-dark-200 rounded-md transition">
                            Electronics
                        </a>
                        <a href="fashion.html" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-dark-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-gray-50 dark:hover:bg-dark-200 rounded-md transition">
                            Fashion
                        </a>
                        <a href="index.html" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-dark-500 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-gray-50 dark:hover:bg-dark-200 rounded-md transition">
                            Home & Garden
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="upload.html" class="bg-indigo-600 dark:bg-indigo-500 text-white h-7 sm:h-8 px-3 sm:px-4 rounded-full flex items-center hover:bg-indigo-700 dark:hover:bg-indigo-600 transition text-sm sm:text-base whitespace-nowrap">
                        <i data-feather="plus" class="h-4 w-4 sm:h-5 sm:w-5 mr-1 sm:mr-2"></i>
                        <span>New Ad</span>
                    </a>
                    <button id="theme-toggle" class="p-1.5 sm:p-2 rounded-full text-gray-500 dark:text-dark-500 hover:bg-gray-100 dark:hover:bg-dark-200">
                        <i data-feather="moon" class="h-5 w-5 dark:hidden"></i>
                        <i data-feather="sun" class="h-5 w-5 hidden dark:block"></i>
                    </button>
                    <button id="user-btn" class="p-1.5 sm:p-2 rounded-full text-gray-500 dark:text-dark-500 hover:bg-gray-100 dark:hover:bg-dark-200 flex items-center">
                        <img id="nav-avatar" src="" alt="" class="hidden h-6 w-6 rounded-full object-cover">
                        <span id="nav-username" class="hidden ml-2 text-sm font-medium"></span>
                        <i data-feather="user" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation Menu (Mobile Only) -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-100 border-t border-gray-200 dark:border-dark-300 z-40" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center justify-center flex-1 py-2 text-gray-600 dark:text-dark-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                <i data-feather="home" class="h-5 w-5 mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center flex-1 py-2 text-gray-600 dark:text-dark-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                <i data-feather="sliders" class="h-5 w-5 mb-1"></i>
                <span class="text-xs">Filters</span>
            </a>
            <a href="index.html" class="flex flex-col items-center justify-center flex-1 py-2 text-gray-600 dark:text-dark-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                <i data-feather="heart" class="h-5 w-5 mb-1"></i>
                <span class="text-xs">Favourites</span>
            </a>
            <a href="upload.html" class="flex flex-col items-center justify-center flex-1 py-2 text-gray-600 dark:text-dark-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                <i data-feather="plus-circle" class="h-5 w-5 mb-1"></i>
                <span class="text-xs">Upload</span>
            </a>
            <a href="index.html" class="flex flex-col items-center justify-center flex-1 py-2 text-gray-600 dark:text-dark-400 hover:text-indigo-600 dark:hover:text-indigo-400">
                <i data-feather="message-circle" class="h-5 w-5 mb-1"></i>
                <span class="text-xs">Messages</span>
            </a>
        </div>
    </div>

    <!-- Hidden Filters (keeping for backward compatibility) -->
    <div class="hidden">
    <div class="bg-white dark:bg-dark-100 shadow-sm dark:shadow-dark-200 sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex space-x-4 overflow-x-auto pb-2 scroll-container">
                <!-- Car Make Filter -->
                <div class="relative">
                    <button id="make-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Make</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="make-filter-menu" class="absolute z-[9999] mt-2 w-72 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-2">
                            <div class="px-3 py-2 sticky top-0 bg-white dark:bg-dark-100">
                                <input type="text" id="make-search" placeholder="Search make" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                            </div>
                            <div class="max-h-96 overflow-y-auto" id="make-list">
                                <!-- Car brands will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Type Filter -->
                <div class="relative">
                    <button id="type-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Type</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="type-filter-menu" class="absolute z-[9999] mt-2 w-56 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-2">
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Cars</span>
                            </label>
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Motorcycles</span>
                            </label>
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Trucks</span>
                            </label>
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Parts</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="relative">
                    <button id="price-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Price</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="price-filter-menu" class="absolute z-[9999] mt-2 w-56 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500 dark:text-dark-400">Min</span>
                                <span class="text-sm text-gray-500 dark:text-dark-400">Max</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <input type="number" placeholder="Min" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                                <span class="text-gray-500 dark:text-dark-400">-</span>
                                <input type="number" placeholder="Max" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                            </div>
                            <button class="mt-4 w-full bg-indigo-600 dark:bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-600 transition">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Year Filter -->
                <div class="relative">
                    <button id="year-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Year</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="year-filter-menu" class="absolute z-[9999] mt-2 w-56 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500 dark:text-dark-400">From</span>
                                <span class="text-sm text-gray-500 dark:text-dark-400">To</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <input type="number" placeholder="From" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                                <span class="text-gray-500 dark:text-dark-400">-</span>
                                <input type="number" placeholder="To" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                            </div>
                            <button class="mt-4 w-full bg-indigo-600 dark:bg-indigo-500 text-white py-2 rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-600 transition">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Condition Filter -->
                <div class="relative">
                    <button id="condition-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Condition</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="condition-filter-menu" class="absolute z-[9999] mt-2 w-56 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-2">
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">New</span>
                            </label>
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Used</span>
                            </label>
                            <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                <span class="ml-2 text-gray-700 dark:text-dark-500">Damaged</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Location Filter -->
                <div class="relative">
                    <button id="location-filter-btn" class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                        <span>Location</span>
                        <i data-feather="chevron-down" class="ml-2 h-4 w-4"></i>
                    </button>
                        <div id="location-filter-menu" class="absolute z-[9999] mt-2 w-56 bg-white dark:bg-dark-100 rounded-md shadow-lg dark:shadow-dark-200" style="display: none;">
                        <div class="p-2">
                            <div class="px-3 py-2">
                                <input type="text" placeholder="Search location" class="w-full px-3 py-2 border border-gray-300 dark:border-dark-200 bg-white dark:bg-dark-100 text-gray-900 dark:text-dark-600 rounded-md">
                            </div>
                            <div class="max-h-60 overflow-y-auto">
                                <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                    <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                    <span class="ml-2 text-gray-700 dark:text-dark-500">Bucharest</span>
                                </label>
                                <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                    <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                    <span class="ml-2 text-gray-700 dark:text-dark-500">Cluj-Napoca</span>
                                </label>
                                <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                    <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                    <span class="ml-2 text-gray-700 dark:text-dark-500">Timișoara</span>
                                </label>
                                <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                                    <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400">
                                    <span class="ml-2 text-gray-700 dark:text-dark-500">Iași</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reset Filters -->
                <button class="filter-option flex items-center px-4 py-2 border border-gray-200 dark:border-dark-200 rounded-full text-sm font-medium text-gray-700 dark:text-dark-500 hover:border-indigo-300 dark:hover:border-indigo-400">
                    <span>Reset</span>
                    <i data-feather="x" class="ml-2 h-4 w-4"></i>
                </button>
            </div>
        </div>
    </div>
    </div>
    <!-- End Hidden Filters -->

    <!-- Video Grid (Portrait/Mobile-optimized) -->
    <div class="video-grid" id="video-grid">
        <!-- Video Card 1: VW Transporter -->
    <div class="video-card" data-video-card data-make="Volkswagen" data-year="2021" data-transmission="Manual" data-fuel="Diesel" data-details-url="details.html?ad=vw-transporter">
            <video loop playsinline preload="auto">
                <source src="Demo ads/VW.m4v" type="video/mp4" />
                Your browser does not support the video tag.
            </video>
            
            <!-- Volume Indicator -->
            <div class="volume-indicator">
                <i data-feather="volume-x" class="h-5 w-5 text-white volume-off"></i>
                <i data-feather="volume-2" class="h-5 w-5 text-white volume-on" style="display: none;"></i>
            </div>
            
            <div class="video-overlay">
                <div class="flex items-center mb-3">
                    <img class="h-10 w-10 rounded-full" src="https://api.dicebear.com/7.x/avataaars/svg?seed=john" alt="Seller">
                    <div class="ml-3">
                        <h3 class="text-white font-medium">John Doe</h3>
                        <p class="text-gray-300 text-sm">2 days ago · Cluj-Napoca</p>
                    </div>
                </div>
                <a href="details.html?ad=vw-transporter" class="block group">
                    <h2 class="text-lg font-bold text-white group-hover:text-indigo-400 transition">VW Transporter T6.1 2021</h2>
                </a>
                <p class="mt-1 text-gray-300 text-sm">45,000 km | Manual | Diesel</p>
                <div class="mt-3 flex items-center justify-between">
                    <span class="text-xl font-bold text-white">€28,500</span>
                    <div class="flex space-x-3">
                        <button class="flex items-center text-white group">
                            <i data-feather="heart" class="h-5 w-5 group-hover:text-pink-500 transition"></i>
                            <span class="ml-1 text-sm">42</span>
                        </button>
                        <button class="flex items-center text-white group">
                            <i data-feather="message-square" class="h-5 w-5 group-hover:text-blue-500 transition"></i>
                            <span class="ml-1 text-sm">12</span>
                        </button>
                        <button class="flex items-center text-white group">
                            <i data-feather="share-2" class="h-5 w-5 group-hover:text-green-500 transition"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Card 2: Audi A5 -->
            <!-- Video Card 2: Audi A5 -->
    <div class="video-card" data-video-card data-make="Audi" data-year="2020" data-transmission="Automatic" data-fuel="Petrol" data-details-url="details.html?ad=audi-a5">
            <video loop playsinline preload="auto">
                <source src="Demo ads/Audi.m4v" type="video/mp4" />
                Your browser does not support the video tag.
            </video>
            
            <!-- Volume Indicator -->
            <div class="volume-indicator">
                <i data-feather="volume-x" class="h-5 w-5 text-white volume-off"></i>
                <i data-feather="volume-2" class="h-5 w-5 text-white volume-on" style="display: none;"></i>
            </div>
            
            <div class="video-overlay">
                <div class="flex items-center mb-3">
                    <img class="h-10 w-10 rounded-full" src="https://api.dicebear.com/7.x/avataaars/svg?seed=jane" alt="Seller">
                    <div class="ml-3">
                        <h3 class="text-white font-medium">Jane Smith</h3>
                        <p class="text-gray-300 text-sm">5 days ago · Bucharest</p>
                    </div>
                </div>
                <a href="details.html?ad=audi-a5" class="block group">
                    <h2 class="text-lg font-bold text-white group-hover:text-indigo-400 transition">Audi A5 Sportback 2020</h2>
                </a>
    </div>

    <script type="module">
        import { filterManager } from './js/filter-manager.js';
        import { carBrands } from './js/car-brands.js';
        import './components/user-dropdown.js';

        const applyFeatherIcons = () => {
            if (window.feather && typeof window.feather.replace === 'function') {
                window.feather.replace();
            }
        };

        const updateFilterBadges = (count) => {
            const headerBadge = document.getElementById('filter-badge');
            const floatingBadge = document.getElementById('floating-badge');

            if (headerBadge) {
                if (count > 0) {
                    headerBadge.textContent = `${count} filter${count > 1 ? 's' : ''}`;
                    headerBadge.classList.remove('hidden');
                } else {
                    headerBadge.classList.add('hidden');
                }
            }

            if (floatingBadge) {
                if (count > 0) {
                    floatingBadge.textContent = count;
                    floatingBadge.classList.remove('hidden');
                } else {
                    floatingBadge.classList.add('hidden');
                }
            }
        };

        const applyFiltersFromSearch = () => {
            const saved = localStorage.getItem('automotiveFilters');
            if (!saved) return;

            let filters;
            try {
                filters = JSON.parse(saved);
            } catch (err) {
                console.error('Failed to parse saved filters', err);
                localStorage.removeItem('automotiveFilters');
                return;
            }

            const videoCards = document.querySelectorAll('[data-video-card]');

            const matchesValue = (filterValue, datasetValue) => {
                if (!filterValue) return true;
                if (Array.isArray(filterValue)) {
                    if (filterValue.length === 0) return true;
                    return filterValue.includes(datasetValue);
                }
                return filterValue === datasetValue;
            };

            videoCards.forEach(card => {
                const visible =
                    matchesValue(filters.make, card.dataset.make) &&
                    matchesValue(filters.year, card.dataset.year) &&
                    matchesValue(filters.transmission, card.dataset.transmission) &&
                    matchesValue(filters.fuel, card.dataset.fuel);

                card.style.display = visible ? '' : 'none';
                
                // Pause and reset hidden videos
                if (!visible) {
                    const video = card.querySelector('video');
                    if (video) {
                        video.pause();
                        video.currentTime = 0;
                    }
                }
            });

            // On mobile, trigger autoplay for first visible video after filtering
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    const firstVisibleCard = document.querySelector('[data-video-card]:not([style*="display: none"])');
                    if (firstVisibleCard) {
                        const video = firstVisibleCard.querySelector('video');
                        if (video) {
                            // Scroll to first visible video
                            firstVisibleCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            
                            // Ensure video is loaded and trigger play after scroll
                            setTimeout(() => {
                                const userMuted = localStorage.getItem('videoMuted') === 'true';
                                video.load(); // Force reload to ensure first frame loads
                                video.muted = userMuted;
                                video.currentTime = 0;
                                const playAttempt = video.play();
                                if (playAttempt && typeof playAttempt.catch === 'function') {
                                    playAttempt.catch(() => {
                                        video.muted = true;
                                        video.play();
                                    });
                                }
                            }, 300);
                        }
                    }
                }, 100);
            }

            const activeFilters = Object.values(filters).filter(value => {
                if (Array.isArray(value)) return value.length > 0;
                return Boolean(value);
            }).length;

            updateFilterBadges(activeFilters);
            localStorage.removeItem('automotiveFilters');
        };

        const setupFilterMenus = () => {
            const buttons = document.querySelectorAll('[id$="-filter-btn"]');
            const menus = document.querySelectorAll('[id$="-filter-menu"]');

            const closeAllMenus = (exceptionId) => {
                menus.forEach(menu => {
                    if (!exceptionId || menu.id !== exceptionId) {
                        menu.classList.add('hidden');
                        menu.style.display = 'none';
                    }
                });
            };

            buttons.forEach(btn => {
                if (btn.id === 'vertical-filter-btn') return;

                btn.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();

                    const menuId = btn.id.replace('-btn', '-menu');
                    const menu = document.getElementById(menuId);
                    if (!menu) return;

                    const shouldOpen = menu.classList.contains('hidden') || getComputedStyle(menu).display === 'none';
                    closeAllMenus(menuId);

                    if (shouldOpen) {
                        menu.classList.remove('hidden');
                        menu.style.display = 'block';
                    } else {
                        menu.classList.add('hidden');
                        menu.style.display = 'none';
                    }
                });
            });

            menus.forEach(menu => {
                menu.classList.add('hidden');
                menu.style.display = 'none';
                menu.addEventListener('click', event => event.stopPropagation());
            });

            document.addEventListener('click', () => closeAllMenus());
        };

        const setupMakeFilter = () => {
            const makeList = document.getElementById('make-list');
            const makeSearch = document.getElementById('make-search');
            if (!makeList || !makeSearch) return;

            const renderBrands = (brands) => {
                makeList.innerHTML = brands.map(({ brand, count }) => `
                    <label class="flex items-center px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-200 cursor-pointer">
                        <input type="checkbox" class="rounded text-indigo-600 dark:text-indigo-400" value="${brand}">
                        <span class="ml-2 text-gray-700 dark:text-dark-500">${brand}</span>
                        <span class="ml-auto text-gray-500 dark:text-dark-400 text-sm">${count}</span>
                    </label>
                `).join('');
            };

            renderBrands(carBrands);

            makeSearch.addEventListener('input', event => {
                const query = event.target.value.trim().toLowerCase();
                const filtered = carBrands.filter(({ brand }) => brand.toLowerCase().includes(query));
                renderBrands(filtered);
            });

            makeList.addEventListener('change', () => {
                const selected = Array.from(makeList.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(input => input.value);
                filterManager.setFilter('make', selected);
            });
        };

        const setupThemeToggle = () => {
            const themeToggle = document.getElementById('theme-toggle');
            if (!themeToggle) return;

            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
            });
        };

        const bindUserButton = () => {
            const userBtn = document.getElementById('user-btn');
            if (!userBtn) return;

            userBtn.addEventListener('click', event => {
                event.preventDefault();
                event.stopPropagation();

                try {
                    const authToken = localStorage.getItem('authToken');
                    const sessionToken = localStorage.getItem('sessionToken');
                    
                    if (!authToken && !sessionToken) {
                        const authModal = document.createElement('auth-modal');
                        document.body.appendChild(authModal);
                        return;
                    }

                    // Ensure user-dropdown is loaded
                    if (!customElements.get('user-dropdown')) {
                        console.error('user-dropdown component not loaded');
                        return;
                    }

                    const dropdown = document.createElement('user-dropdown');
                    const rect = userBtn.getBoundingClientRect();
                    // Position the host element where the button is (component will use this for positioning)
                    dropdown.style.position = 'absolute';
                    dropdown.style.left = `${rect.left}px`;
                    dropdown.style.top = `${rect.bottom}px`;
                    dropdown.style.width = '0';
                    dropdown.style.height = '0';
                    document.body.appendChild(dropdown);
                } catch (err) {
                    console.error('Failed to open user menu', err);
                }
            });
        };

        const updateNavAuthUI = () => {
            const avatar = localStorage.getItem('userAvatar');
            const name = localStorage.getItem('userName');
            const sessionToken = localStorage.getItem('sessionToken') || localStorage.getItem('authToken');
            const avatarEl = document.getElementById('nav-avatar');
            const nameEl = document.getElementById('nav-username');
            const userBtn = document.getElementById('user-btn');
            const iconSvg = userBtn ? userBtn.querySelector('svg') : null;

            if (sessionToken && avatar && avatarEl) {
                avatarEl.src = avatar;
                avatarEl.classList.remove('hidden');
                if (iconSvg) iconSvg.classList.add('hidden');
            } else {
                if (avatarEl) avatarEl.classList.add('hidden');
                if (iconSvg) iconSvg.classList.remove('hidden');
            }

            if (sessionToken && name && nameEl) {
                nameEl.textContent = name;
                nameEl.classList.remove('hidden');
            } else if (nameEl) {
                nameEl.classList.add('hidden');
            }
        };

        const initVideos = () => {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth < 1024;
            const videoCards = document.querySelectorAll('[data-video-card]');
            let currentlyPlayingVideo = null; // Track which video is playing on desktop

            videoCards.forEach((card, index) => {
                const video = card.querySelector('video');
                const volumeIndicator = card.querySelector('.volume-indicator');
                const detailsUrl = card.getAttribute('data-details-url');
                if (!video || !volumeIndicator) return;

                const volumeOff = volumeIndicator.querySelector('.volume-off');
                const volumeOn = volumeIndicator.querySelector('.volume-on');
                let volumeTimeout;

                const updateVolumeIcon = (muted) => {
                    if (volumeOff && volumeOn) {
                        volumeOff.style.display = muted ? 'block' : 'none';
                        volumeOn.style.display = muted ? 'none' : 'block';
                    }
                };

                const flashVolumeIndicator = () => {
                    volumeIndicator.classList.remove('fade-out');
                    clearTimeout(volumeTimeout);
                    volumeTimeout = window.setTimeout(() => {
                        volumeIndicator.classList.add('fade-out');
                    }, 1500);
                };

                video.setAttribute('playsinline', '');
                video.setAttribute('webkit-playsinline', '');
                video.muted = true;
                
                // Force iOS to load video metadata
                video.load();

                const showFirstFrame = () => {
                    video.muted = true;
                    const playPromise = video.play();
                    if (playPromise && typeof playPromise.then === 'function') {
                        playPromise.then(() => {
                            window.setTimeout(() => {
                                // On mobile, pause all except first; on desktop, pause all initially
                                if (isMobile) {
                                    if (index !== 0) {
                                        video.pause();
                                        video.currentTime = 0;
                                    }
                                } else {
                                    // Desktop: pause after showing first frame, except for first video
                                    if (index !== 0) {
                                        video.pause();
                                        video.currentTime = 0;
                                    } else {
                                        // First video autoplays on desktop
                                        currentlyPlayingVideo = video;
                                    }
                                }
                            }, 100);
                        }).catch(() => {
                            video.currentTime = 0.1;
                        });
                    }
                };

                if (video.readyState >= 2) {
                    showFirstFrame();
                } else {
                    video.addEventListener('loadeddata', showFirstFrame, { once: true });
                }

                let userMutedPreference = false;

                const applyMuteState = (muted) => {
                    video.muted = muted;
                    userMutedPreference = muted;
                    updateVolumeIcon(muted);
                    flashVolumeIndicator();
                };

                const toggleAudio = () => {
                    const targetMuted = !video.muted;
                    applyMuteState(targetMuted);

                    if (!targetMuted && video.paused) {
                        const resumeAttempt = video.play();
                        if (resumeAttempt && typeof resumeAttempt.catch === 'function') {
                            resumeAttempt.catch(() => applyMuteState(true));
                        }
                    }
                };

                if (isMobile) {
                    const observer = new IntersectionObserver(entries => {
                        entries.forEach(entry => {
                            // Only process if card is not hidden by filters
                            if (card.style.display === 'none') return;
                            
                            if (entry.isIntersecting && entry.intersectionRatio >= 0.75) {
                                video.muted = userMutedPreference;
                                const playAttempt = video.play();
                                if (playAttempt && typeof playAttempt.then === 'function') {
                                    playAttempt.then(() => {
                                        updateVolumeIcon(video.muted);
                                        flashVolumeIndicator();
                                    }).catch(() => {
                                        video.muted = true;
                                        userMutedPreference = true;
                                        updateVolumeIcon(true);
                                        flashVolumeIndicator();
                                    });
                                }
                            } else {
                                video.pause();
                                video.currentTime = 0;
                            }
                        });
                    }, { threshold: [0.75] });

                    observer.observe(card);

                } else {
                    // Desktop: TikTok-style autoplay behavior
                    card.addEventListener('mouseenter', () => {
                        // Pause currently playing video if it's different
                        if (currentlyPlayingVideo && currentlyPlayingVideo !== video) {
                            currentlyPlayingVideo.pause();
                        }
                        
                        // Play this video
                        video.muted = userMutedPreference;
                        const playAttempt = video.play();
                        if (playAttempt && typeof playAttempt.then === 'function') {
                            playAttempt.then(() => {
                                currentlyPlayingVideo = video;
                                updateVolumeIcon(video.muted);
                                flashVolumeIndicator();
                            }).catch(() => {
                                video.muted = true;
                                userMutedPreference = true;
                                updateVolumeIcon(true);
                                flashVolumeIndicator();
                            });
                        }
                    });

                    // On desktop, don't pause on mouse leave - let video continue playing
                    // This creates the TikTok effect where videos play until you hover another one
                }

                volumeIndicator.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleAudio();
                });

                if (detailsUrl) {
                    // Handle card click (excluding links, buttons, and volume indicator)
                    card.addEventListener('click', event => {
                        if (event.target.closest('a, button, .volume-indicator')) return;

                        try {
                            sessionStorage.setItem('detailsScrollTarget', 'description');
                        } catch (err) {
                            console.warn('Unable to persist scroll preference', err);
                        }

                        window.location.href = detailsUrl;
                    });
                    
                    // Handle title link click - also scroll to description
                    const titleLink = card.querySelector('a[href]');
                    if (titleLink) {
                        titleLink.addEventListener('click', event => {
                            try {
                                sessionStorage.setItem('detailsScrollTarget', 'description');
                            } catch (err) {
                                console.warn('Unable to persist scroll preference', err);
                            }
                            // Let the default link navigation happen
                        });
                    }
                }

                updateVolumeIcon(video.muted);
                window.setTimeout(() => volumeIndicator.classList.add('fade-out'), 2000);
            });
        };

        const registerServiceWorker = () => {
            if (!('serviceWorker' in navigator)) return;

            navigator.serviceWorker.register('/service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        };

        document.addEventListener('DOMContentLoaded', () => {
            applyFeatherIcons();
            applyFiltersFromSearch();
            setupFilterMenus();
            setupMakeFilter();
            setupThemeToggle();
            bindUserButton();
            updateNavAuthUI();
            initVideos();
            window.setTimeout(applyFeatherIcons, 100);

            // Auto-hide Safari address bar on iOS
            // Trigger a small scroll to hide the address bar
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                window.scrollTo(0, 1);
                // Also hide on page show (back button)
                window.addEventListener('pageshow', () => {
                    setTimeout(() => window.scrollTo(0, 1), 100);
                });
            }
        });

        applyFeatherIcons();
        window.addEventListener('load', registerServiceWorker);
    </script>
</body>
</html>
