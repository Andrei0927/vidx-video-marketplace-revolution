{% extends "base.html" %}

{% block title %}Upload New Ad - Step 3: Review & Publish - VidX{% endblock %}

{% block content %}
<!-- Upload Form Container -->
<div class="max-w-3xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <div class="bg-white dark:bg-dark-100 shadow dark:shadow-dark-200 rounded-lg overflow-hidden">
        <!-- Progress Stepper -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-dark-200">
            <div class="flex items-center justify-between">
                <!-- Step 1 - Complete -->
                <div class="flex items-center flex-1">
                    <div class="flex-shrink-0 bg-green-500 rounded-full h-8 w-8 flex items-center justify-center">
                        <i data-feather="check" class="h-5 w-5 text-white"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-dark-400">Upload Media</h3>
                    </div>
                </div>
                
                <!-- Step 2 - Complete -->
                <div class="flex items-center flex-1">
                    <div class="flex-shrink-0 bg-green-500 rounded-full h-8 w-8 flex items-center justify-center">
                        <i data-feather="check" class="h-5 w-5 text-white"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-dark-400">Add Details</h3>
                    </div>
                </div>
                
                <!-- Step 3 - Active -->
                <div class="flex items-center flex-1">
                    <div class="flex-shrink-0 bg-indigo-600 dark:bg-indigo-500 rounded-full h-8 w-8 flex items-center justify-center">
                        <span class="text-white font-medium">3</span>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-600">Publish</h3>
                        <p class="text-sm text-gray-500 dark:text-dark-400">Review and submit</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Section -->
        <div class="px-6 py-8 space-y-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-900 dark:text-dark-600 mb-4">Review Your Listing</h2>
                <p class="text-sm text-gray-500 dark:text-dark-400">Please review your listing details before publishing</p>
            </div>

            <!-- Ad Preview -->
            <div class="border border-gray-200 dark:border-dark-200 rounded-lg overflow-hidden">
                <!-- Media Preview -->
                <div class="bg-black aspect-video relative">
                    <div id="media-preview" class="w-full h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <i data-feather="image" class="h-24 w-24 mx-auto"></i>
                            <p class="mt-2">Media preview will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Details Preview -->
                <div class="p-6 space-y-4">
                    <div>
                        <h3 id="preview-title" class="text-2xl font-bold text-gray-900 dark:text-dark-600"></h3>
                        <p id="preview-price" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mt-2"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-dark-400">Category</p>
                            <p id="preview-category" class="font-medium text-gray-900 dark:text-dark-600"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-dark-400">Condition</p>
                            <p id="preview-condition" class="font-medium text-gray-900 dark:text-dark-600"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-dark-400">Location</p>
                            <p id="preview-location" class="font-medium text-gray-900 dark:text-dark-600"></p>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 dark:border-dark-200 pt-4">
                        <p class="text-sm text-gray-500 dark:text-dark-400 mb-2">Description</p>
                        <p id="preview-description" class="text-gray-700 dark:text-dark-500 whitespace-pre-line"></p>
                    </div>
                </div>
            </div>

            <!-- AI Video Generation -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-dark-600 flex items-center">
                            <i data-feather="video" class="h-5 w-5 mr-2 text-indigo-600 dark:text-indigo-400"></i>
                            AI Video Generation
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-dark-400 mt-1">
                            Generate a professional Romanian video ad automatically (~2 minutes, ‚Ç¨0.02)
                        </p>
                        <div id="video-status" class="mt-3 hidden">
                            <div class="flex items-center text-sm">
                                <div class="animate-spin h-4 w-4 border-2 border-indigo-600 dark:border-indigo-400 border-t-transparent rounded-full mr-2"></div>
                                <span id="video-status-text" class="text-indigo-700 dark:text-indigo-300">Generating video...</span>
                            </div>
                            <div class="mt-2 bg-white dark:bg-dark-100 rounded-lg p-2">
                                <div class="w-full bg-gray-200 dark:bg-dark-200 rounded-full h-2">
                                    <div id="video-progress" class="bg-indigo-600 dark:bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div id="video-result" class="mt-3 hidden">
                            <div class="flex items-center text-sm text-green-700 dark:text-green-300">
                                <i data-feather="check-circle" class="h-4 w-4 mr-2"></i>
                                <span>Video generated successfully! Preview appears above.</span>
                            </div>
                            <div class="mt-3">
                                <a id="video-preview-link" href="#" target="_blank" class="inline-flex items-center text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300">
                                    <i data-feather="external-link" class="h-4 w-4 mr-1"></i>
                                    Open video in new tab
                                </a>
                            </div>
                        </div>
                    </div>
                    <button id="generate-video-btn" type="button" class="ml-4 px-4 py-2 bg-indigo-600 dark:bg-indigo-500 text-white rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors">
                        Generate Video
                    </button>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="bg-gray-50 dark:bg-dark-50 rounded-lg p-4">
                <label class="flex items-start">
                    <input type="checkbox" id="agree-terms" class="mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-3 text-sm text-gray-600 dark:text-dark-400">
                        I agree to the <a href="#" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300">Terms of Service</a> and confirm that this listing complies with VidX's policies.
                    </span>
                </label>
            </div>

            <!-- Publishing Status -->
            <div id="publishing-status" class="hidden">
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="animate-spin h-5 w-5 border-2 border-blue-600 dark:border-blue-400 border-t-transparent rounded-full"></div>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">Publishing your listing...</h3>
                            <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">This may take a few moments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Message (hidden initially) -->
            <div id="success-message" class="hidden">
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i data-feather="check-circle" class="h-6 w-6 text-green-600 dark:text-green-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800 dark:text-green-200">Success!</h3>
                            <p class="text-sm text-green-700 dark:text-green-300 mt-1">Your listing has been published successfully</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between pt-6 border-t border-gray-200 dark:border-dark-200">
                <a href="{{ url_for('upload.upload_step2') }}" class="px-4 py-2 border border-gray-300 dark:border-dark-200 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-dark-500 bg-white dark:bg-dark-100 hover:bg-gray-50 dark:hover:bg-dark-200">
                    Back to Edit
                </a>
                <button id="publish-btn" disabled class="px-6 py-2 bg-indigo-600 dark:bg-indigo-500 text-white rounded-md shadow-sm text-sm font-medium hover:bg-indigo-700 dark:hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    Publish Listing
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Video Card Renderer -->
<script src="{{ url_for('static', filename='js/video-card-renderer.js') }}"></script>
<script>
    // Load and display saved data
    const savedData = sessionStorage.getItem('adDetails');
    const uploadedFiles = sessionStorage.getItem('uploadedFiles');
    const agreeTerms = document.getElementById('agree-terms');
    const publishBtn = document.getElementById('publish-btn');
    const generateVideoBtn = document.getElementById('generate-video-btn');
    
    let generatedAdData = null;
    let adData = null;
    
    if (savedData) {
        adData = JSON.parse(savedData);
        
        // Populate preview
        document.getElementById('preview-title').textContent = adData.title;
        document.getElementById('preview-price').textContent = '‚Ç¨' + adData.price;
        document.getElementById('preview-category').textContent = capitalizeCategory(adData.category);
        document.getElementById('preview-condition').textContent = capitalizeCondition(adData.condition);
        document.getElementById('preview-location').textContent = adData.location;
        document.getElementById('preview-description').textContent = adData.description;
        
        // Display uploaded media preview
        if (uploadedFiles) {
            try {
                const files = JSON.parse(uploadedFiles);
                const mediaPreview = document.getElementById('media-preview');
                
                if (files && files.length > 0) {
                    const firstFile = files[0];
                    
                    console.log('Showing uploaded media preview:', firstFile);
                    
                    // Check if it's a video or image
                    if (firstFile.type && firstFile.type.startsWith('video/')) {
                        mediaPreview.innerHTML = `
                            <video 
                                src="${firstFile.url || firstFile.dataUrl}" 
                                class="w-full h-full object-cover" 
                                controls 
                                muted 
                                autoplay
                                loop>
                            </video>
                        `;
                    } else if (firstFile.type && firstFile.type.startsWith('image/')) {
                        mediaPreview.innerHTML = `
                            <img 
                                src="${firstFile.url || firstFile.dataUrl}" 
                                class="w-full h-full object-cover" 
                                alt="Preview">
                        `;
                    }
                }
            } catch (e) {
                console.error('Error displaying media preview:', e);
                console.log('uploadedFiles raw:', uploadedFiles);
            }
        } else {
            console.warn('No uploadedFiles found in sessionStorage');
        }
    } else {
        // No data, redirect to step 1
        window.location.href = "{{ url_for('upload.upload_step1') }}";
    }
    
    // Enable publish button when terms are agreed
    agreeTerms.addEventListener('change', () => {
        publishBtn.disabled = !agreeTerms.checked;
    });
    
    // Generate Video button handler
    generateVideoBtn.addEventListener('click', async () => {
        const videoStatus = document.getElementById('video-status');
        const videoStatusText = document.getElementById('video-status-text');
        const videoProgress = document.getElementById('video-progress');
        const videoResult = document.getElementById('video-result');
        const videoPreviewLink = document.getElementById('video-preview-link');
        
        // Show status
        videoStatus.classList.remove('hidden');
        videoResult.classList.add('hidden');
        generateVideoBtn.disabled = true;
        generateVideoBtn.textContent = 'Generating...';
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            videoProgress.style.width = progress + '%';
        }, 500);
        
        try {
            // Get uploaded images from sessionStorage
            const images = [];
            const uploadedFiles = sessionStorage.getItem('uploadedFiles');
            
            if (uploadedFiles) {
                try {
                    const files = JSON.parse(uploadedFiles);
                    console.log('üì∏ Found uploaded files:', files.length);
                    
                    // Extract base64 data or URLs from uploaded files
                    for (const file of files) {
                        if (file.dataUrl) {
                            // Already have base64 data
                            images.push(file.dataUrl);
                            console.log('  ‚úì Added image from dataUrl');
                        } else if (file.url) {
                            // Have URL - would need to fetch and convert
                            console.warn('  ‚ö†Ô∏è File has URL but no dataUrl:', file.url);
                        }
                    }
                    
                    console.log(`üì∏ Prepared ${images.length} images for video generation`);
                } catch (e) {
                    console.error('Error parsing uploaded files:', e);
                }
            } else {
                console.warn('‚ö†Ô∏è No uploaded files found in sessionStorage');
            }
            
            // Prepare request payload
            const payload = {
                title: adData.title,
                category: adData.category,
                description: adData.description,
                price: parseFloat(adData.price),
                details: {
                    condition: adData.condition,
                    location: adData.location
                },
                images: images  // Base64 encoded images
            };
            
            console.log('üé¨ Requesting video generation:', payload);
            
            // Update status
            videoStatusText.textContent = 'Step 1/5: Generating script...';
            
            // Call video generation API
            const response = await fetch('/api/video/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            clearInterval(progressInterval);
            videoProgress.style.width = '100%';
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Video generated:', result);
                
                // Store full ad data from API response
                generatedAdData = result.ad;
                
                // Replace media preview with generated video
                const mediaPreview = document.getElementById('media-preview');
                mediaPreview.innerHTML = `
                    <video 
                        src="${result.video_url}" 
                        class="w-full h-full object-cover" 
                        controls 
                        muted 
                        autoplay
                        loop>
                    </video>
                `;
                
                // Show success
                videoStatus.classList.add('hidden');
                videoResult.classList.remove('hidden');
                videoPreviewLink.href = result.video_url;
                
                // Store video data with ad data
                adData.videoUrl = result.video_url;
                adData.generatedAd = generatedAdData;
                sessionStorage.setItem('adDetails', JSON.stringify(adData));
                
                generateVideoBtn.textContent = 'Regenerate Video';
                generateVideoBtn.disabled = false;
                
            } else {
                throw new Error(result.error || 'Video generation failed');
            }
            
        } catch (error) {
            console.error('‚ùå Video generation error:', error);
            
            clearInterval(progressInterval);
            
            videoStatus.classList.add('hidden');
            generateVideoBtn.disabled = false;
            generateVideoBtn.textContent = 'Retry Generation';
            
            alert('Error generating video: ' + error.message + '\n\nPlease try again or continue without video.');
        }
    });
    
    // Publish button handler
    publishBtn.addEventListener('click', async () => {
        const publishingStatus = document.getElementById('publishing-status');
        const successMessage = document.getElementById('success-message');
        
        // Show publishing status
        publishBtn.disabled = true;
        publishingStatus.classList.remove('hidden');
        
        try {
            // Prepare listing data
            const listingData = generatedAdData || {
                id: 'listing-' + Date.now(),
                title: adData.title,
                category: adData.category,
                price: parseFloat(adData.price),
                currency: 'EUR',
                description: adData.description,
                location: adData.location,
                condition: adData.condition,
                videoUrl: adData.videoUrl || '',
                thumbnailUrl: adData.thumbnailUrl || '',
                publishedAt: new Date().toISOString(),
                status: 'active',
                metadata: {
                    condition: adData.condition,
                    features: []
                }
            };
            
            console.log('üì§ Publishing listing:', listingData);
            
            // Save to localStorage for immediate display
            const publishedAds = JSON.parse(localStorage.getItem('publishedAds') || '[]');
            publishedAds.unshift(listingData);
            localStorage.setItem('publishedAds', JSON.stringify(publishedAds));
            
            // Save to database via API
            try {
                const response = await fetch('/api/listings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(listingData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Listing saved to database:', result);
                } else {
                    console.warn('‚ö†Ô∏è Failed to save to database, using localStorage only');
                }
            } catch (apiError) {
                console.warn('‚ö†Ô∏è API error, using localStorage only:', apiError);
            }
            
            // Show success
            publishingStatus.classList.add('hidden');
            successMessage.classList.remove('hidden');
            
            // Clear session storage
            sessionStorage.removeItem('adDetails');
            sessionStorage.removeItem('uploadStep');
            sessionStorage.removeItem('uploadDraft');
            sessionStorage.removeItem('uploadedFiles');
            
            // Redirect to user's ads after 2 seconds
            setTimeout(() => {
                window.location.href = "{{ url_for('user.my_ads') }}";
            }, 2000);
            
        } catch (error) {
            publishingStatus.classList.add('hidden');
            alert('Error publishing listing. Please try again.');
            publishBtn.disabled = false;
        }
    });
    
    // Helper functions
    function capitalizeCategory(category) {
        const categories = {
            'electronics': 'Electronics',
            'fashion': 'Fashion',
            'automotive': 'Automotive',
            'home-garden': 'Home & Garden',
            'sports': 'Sports & Outdoors',
            'real-estate': 'Real Estate',
            'jobs': 'Jobs',
            'services': 'Services'
        };
        return categories[category] || category;
    }
    
    function capitalizeCondition(condition) {
        const conditions = {
            'new': 'New',
            'like-new': 'Like New',
            'good': 'Good',
            'fair': 'Fair'
        };
        return conditions[condition] || condition;
    }
</script>
{% endblock %}
